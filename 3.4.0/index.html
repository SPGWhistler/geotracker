<!DOCTYPE html><!--HTML5 doctype-->
<html>
	<head>
		<title>Powered by appStarter</title>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8"> 
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<link rel='stylesheet' type='text/css' href='css/jq.ui.frosty.css' />
		<link rel="stylesheet" type="text/css" href="css/icons.css">
		<script type="text/javascript" charset="utf-8" src="http://localhost:58888/_appMobi/appmobi.js"></script> 
		<script type="text/javascript" charset="utf-8" src="http://localhost:58888/_appMobi/xhr.js"></script>  
		<script type="text/javascript" charset="utf-8" src="libs/jq.ui.min.js"></script> 
		<script type="text/javascript" charset="utf-8" src="libs/jq.web.min.js"></script> 
		<script type="text/javascript" charset="utf-8" src="libs/xpromo.js"></script> 
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>

		<script type="text/javascript">
			var lastGeo = null;
			var lastUGeo = null;

			/* Prevent users from scrolling the page */
			var preventDefaultScroll = function(event) {
			    event.preventDefault();
			    window.scroll(0,0);
			    return false;
			};
			document.addEventListener('touchmove', preventDefaultScroll, false);

			/* This function runs once the page is loaded, but appMobi is not yet active */
			$.ui.autoLaunch=false;
			var init = function(){
				$.ui.showBackbutton=false;
			};
			document.addEventListener("DOMContentLoaded",init,false);

			/* This code is used to run as soon as appMobi activates */
			var onDeviceReady=function(){
				AppMobi.device.setRotateOrientation("portrait");
				AppMobi.device.setAutoRotate(false);
				AppMobi.device.hideSplashScreen();
				$.ui.launch();
				$.ui.toggleHeaderMenu();
				$.ui.updateNavbarElements($('#footer_start').html());
				initMap();
				setInterval('getLocation()', 10000); //Get my location every 30 seconds
				AppMobi.geolocation.getCurrentPosition(gotLocation, noLocation);
			};
			document.addEventListener("appMobi.device.ready",onDeviceReady,false);

			function getLocation(){
				var d = new Date();
				var t = d.getTime();
				if (lastGeo === null || t - lastGeo > 30) {
					lastGeo = t;
					AppMobi.geolocation.getCurrentPosition(gotLocation, noLocation);
				}
			}

			function gotLocation(p){
				$.getJSON('http://192.168.11.12/~tpetty/geotracker/index.php?uuid=' + AppMobi.device.uuid + '&lat=' + p.coords.latitude + '&lng=' + p.coords.longitude);
				var newLL = new google.maps.LatLng(p.coords.latitude, p.coords.longitude);
				if (uMarker === null) {
					map.panTo(newLL);
				}
				if (myMarker === null) {
					myMarker = new google.maps.Marker({
						position: newLL,
						map: map,
						title: 'my current location'
					});
				} else {
					myMarker.setPosition(newLL);
				}
			}

			function noLocation(){
			}

			function getUserLocation(){
				console.log('getUserLocation');
				var uuid = AppMobi.cache.getCookie('uuid');
				if (typeof uuid !== 'undefined') {
					var d = new Date();
					var t = d.getTime();
					if (lastUGeo === null || t - lastUGeo > 30) {
						lastUGeo = t;
						console.log('getting it ' + uuid);
						$.getJSON('http://192.168.11.12/~tpetty/geotracker/index.php?uuid=' + uuid, function(data){
							console.log(data);
							var newLL = new google.maps.LatLng(data.lat, data.lng);
							var mybounds = new google.maps.LatLngBounds();
							mybounds.extend(newLL);
							mybounds.extend(myMarker.getPosition());
							if (uMarker === null) {
								uMarker = new google.maps.Marker({
									position: newLL,
									map: map,
									title: 'user current location'
								});
							} else {
								uMarker.setPosition(newLL);
							}
							map.fitBounds(mybounds);
						});
					}
				} else {
					alert('Scan a QR Code first.');
				}
			}

			var map;
			google.maps.visualRefresh = true;
			var myMarker = null;
			var uMarker = null;
			function initMap() {
				var mapOptions = {
					zoom: 16,
					center: new google.maps.LatLng(-34.397, 150.644),
					mapTypeId: google.maps.MapTypeId.ROADMAP,
					streetViewControl: false
				};
				map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
			}

			function scanQRCode(){
				AppMobi.device.scanBarcode();
			}

			document.addEventListener("appMobi.device.barcode.scan", gotQRCode, false);
			function gotQRCode(e){
				if (e.success === true){
					AppMobi.cache.setCookie('uuid', e.codedata, -1);
					alert('Saved uuid.');
				}
			}

			var uTrackInt = null;
			function startTracking(){
				$.ui.updateNavbarElements($('#footer_stop').html());
				uTrackInt = setInterval('getUserLocation()', 10000);
			}

			function stopTracking(){
				$.ui.updateNavbarElements($('#footer_start').html());
				clearInterval(uTrackInt);
				uTrackInt = null;
			}
		</script>
	</head>
	<body>
		<div id="jQUi">
			<div id="splashscreen" class='ui-loader'>
				<span class='ui-icon ui-icon-loading spin'></span><h1 >Starting app</h1>
			</div>
			<div id="content">
				<div id='main' class='panel' style="width: 100%; height: 100%">
					<div style="width: 100%; height: 100%;" id="map-canvas"></div>
				</div>
				<div id='info' class='panel'>
					<br />
					<script>
						function getQRCode(){
							$.ui.addContentDiv("myDiv","<img src='http://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=" + AppMobi.device.uuid + "' />","Title");
							$.ui.loadContent('myDiv',false,true,'up');
						}
					</script>
				</div>
			</div>
			<div id='navbar'>
			</div>
			<footer id="footer_start">
				<a href='#' onclick="getUserLocation();" class='icon magnifier'>Find</a>
				<a href='#' id="start_tracking" onclick="startTracking();" class='icon location'>Track</a>
				<a href='#' onclick="getQRCode();" class='icon info'>Into</a>
				<a href='#' onclick="scanQRCode();" class='icon camera'>Scan</a>
			</footer>
			<footer id="footer_stop">
				<a href='#' onclick="getUserLocation();" class='icon magnifier'>Find</a>
				<a href='#' id="stop_tracking" onclick="stopTracking();" class='icon location'>Stop</a>
				<a href='#' onclick="getQRCode();" class='icon info'>Into</a>
				<a href='#' onclick="scanQRCode();" class='icon camera'>Scan</a>
			</footer>
		</div>
	</body>
</html>
